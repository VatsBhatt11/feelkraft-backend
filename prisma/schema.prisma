generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String     @id @default(uuid()) @db.Uuid
  email                String?    @unique
  isPro                Boolean    @default(false)
  freeGenerationsCount Int        @default(0)
  createdAt            DateTime   @default(now())
  jobs                 ComicJob[]
}

model ComicJob {
  id     String    @id @default(uuid()) @db.Uuid
  userId String    @db.Uuid
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status JobStatus @default(PENDING)

  // Input data
  image1Url      String
  image2Url      String
  prompt         String?
  theme          String
  style          String
  character1Name String?
  character2Name String?

  // Output data
  pageCount       Int      @default(1)
  generatedImages String[] @default([])
  pdfUrl          String?

  // Tracking
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  logs          GenerationLog[]
  refundRequest RefundRequest?
}

enum JobStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

model RefundRequest {
  id        String   @id @default(uuid()) @db.Uuid
  jobId     String   @unique @db.Uuid
  job       ComicJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reason    String?
  createdAt DateTime @default(now())
}

model GenerationLog {
  id    String   @id @default(uuid()) @db.Uuid
  jobId String   @db.Uuid
  job   ComicJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  taskId    String // Nano Banana task ID
  pageNum   Int
  status    String // waiting, success, fail
  resultUrl String?
  costTime  Int?
  error     String?

  createdAt DateTime @default(now())
}

model Payment {
  id          String   @id @default(uuid()) @db.Uuid
  orderId     String
  paymentId   String   @unique
  signature   String
  amount      Int
  currency    String
  status      String   @default("success")
  userEmail   String?
  phoneNumber String?
  comicJobId  String?  @db.Uuid
  createdAt   DateTime @default(now())
}
